# Testing

Our approach to testing will change as the project progresses.
In the beginning we focus more on change than on test.

## Generated OpenAPI client

As the back-end generated by PostgREST cannot be unit-tested, and the key to
the success of the project is to have a good API, it makes sense to test
thoroughly the API from the outside, _i.e._, through an API client.

As a custom API client is quite an amount of code to maintain, we are using a
generator instead, that creates utility classes from the OpenAPI specification.
It also allows us to make sure the OpenAPI specification is in a good shape and
up to date. We use [openapi-python-client](https://github.com/openapi-generators/openapi-python-client)
because it is open source, free and subscription-free, so it is easy to set up.

The API client is generated in the `test/flex` directory, and tests
based on it can be found under the `test/api-tests` directory. These tests chain
several calls to the API, capturing some of the returned data and using it in
further calls. This is very useful to test not only single API endpoints, but
full scenarios involving several different API calls.

### Setup and teardown

In a given test file, tests can be run with a setup phase, executed before the
tests, and a teardown phase, run after each test, for instance to clean the
internal state of the database if it applies.

In our case, the setup phase is typically the login process, so that we obtain
a single and common API client for all the tests of the file. This is not
required but these operations are useless to repeat for each test, so factoring
them makes the tests a bit faster.

However, our tests are made to be as independent as possible from each other,
and to use new data when possible, instead of interacting with existing data,
which reduces the need for a teardown phase.
The new data could be cleaned after each test, but it does not influence the
other tests, and in some cases it could be a challenge, because some operations
are impossible to revert from outside the API, such as deletions on
history tables.
Therefore, in the current state, tests do not include a teardown phase.

### Test framework

The tests linked to the API client are performed using the [Pytest](https://docs.pytest.org/en/8.2.x/)
library. We also use it for some of the other tests. It is versatile and allows
writing both unit tests, running the same function with a lot of different input
cases, and API tests, running a series of API calls and checking that the
behaviour of the server is correct.

## Authentication API testing

The API client is a handy tool for testing the resource endpoints of the API.
However, it is much less adapted to authentication, which requires another
format of request body and specific headers. Moreover, the authentication
endpoints are the ones providing the token needed to instantiate the API client.
Finally, the URL of the authentication API is different, and it must be
considered as a distinct service. For all these reasons, we are using custom
Pytest test cases with the `requests` library.

It operates at a lower level, because we must describe the whole request, with
URL, headers and body. It is therefore a good combination to have this for
authentication endpoints, but something more automated for the rest of the API.

The authentication tests can be found under the `test/auth_tests` directory.

## Other tests

Other tests can be found under the `test/other_tests` directory.

For instance, we are using property based testing leveraging the OpenAPI
specification, to get some "free" test coverage.

* [Deriving Semantics-Aware Fuzzers from Web API Schemas](https://arxiv.org/abs/2112.10328)
* [hypothesis](https://hypothesis.readthedocs.io/en/latest/)
* [schemathesis](https://github.com/schemathesis/schemathesis)

We are also unit-testing some functions currently implemented in the database,
when possible.

## Partial testing

We offer options in the `just test` command to carry out only part of the tests
and iterate faster.
Indeed, some of them, like the Schemathesis tests, are quite long, and we do not
want to run them all the time.
For more information, run `just test --help`.
